{% extends 'base.html' %}
{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<section class="card card-lg">
  <div class="card-header" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;">
    <div>
      <h2 style="margin:0;">Admin Dashboard</h2><br>
      <p class="muted">Manage students, results, and imports</p>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <a href="{{ url_for('add_student') }}" class="btn">Add Student</a>
      <a href="{{ url_for('add_result') }}" class="btn">Add Result</a>
      <a href="{{ url_for('view_results') }}" class="btn-outline">View Results</a>
      <a href="{{ url_for('import_students') }}" class="btn-outline">Import CSV</a>
    </div>
  </div>

  <!-- Summary cards -->
  <div style="display:flex;gap:14px;flex-wrap:wrap;margin-top:14px;">
    <div class="summary-item">
      <div class="summary-title">Total Students</div>
      <div class="summary-value">{{ stats.total_students }}</div>
    </div>
    <div class="summary-item">
      <div class="summary-title">Total Results</div>
      <div class="summary-value">{{ stats.total_results }}</div>
    </div>
    <div class="summary-item">
      <div class="summary-title">Currently Displayed</div>
      <div class="summary-value">{{ students|length }}</div>
    </div>
  </div>

  <!-- Search bar -->
  <form method="get" action="{{ url_for('admin_dashboard') }}" class="form-inline" style="margin-top:16px;">
    <input class="input" type="search" name="q" placeholder="Search by roll or name" value="{{ q }}">
    <button class="btn" type="submit">Search</button>
  </form>

  <!-- Students table -->
  <div class="table-wrap" style="margin-top:16px;">
    <table class="table">
      <thead>
        <tr>
          <th>Roll</th>
          <th>Name</th>
          <th>Email</th>
          <th class="text-right">Created</th>
          <th class="text-right">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for s in students %}
        <tr>
          <td>{{ s.roll }}</td>
          <td>{{ s.name }}</td>
          <td>{{ s.email or '-' }}</td>
          <td class="text-right" style="color:var(--muted);font-size:0.95rem;">
            {{ s.created_at.strftime('%Y-%m-%d') }}
          </td>
          <td class="text-right">
            <a href="{{ url_for('view_results') }}?roll={{ s.roll }}" class="btn-outline" style="padding:6px 8px;border-radius:8px;">View</a>
            <form action="{{ url_for('delete_student', student_id=s.id) }}" method="post" style="display:inline;">
              <button type="submit" class="btn-outline" style="padding:6px 8px;border-radius:8px;"
                      onclick="return confirm('Delete this student and all results?')">
                Delete
              </button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="5" style="text-align:center;">No students found</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div style="display:flex;align-items:center;justify-content:space-between;margin-top:14px;flex-wrap:wrap;">
    <div class="muted">Showing {{ students|length }} of {{ total }} students</div>

    <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
      {% if page > 1 %}
      <a class="btn-outline" href="{{ url_for('admin_dashboard', q=q, page=page-1) }}">Prev</a>
      {% endif %}

      {% set start = page - 2 if page - 2 > 0 else 1 %}
      {% set end = page + 2 if page + 2 <= total_pages else total_pages %}
      {% for p in range(start, end + 1) %}
      {% if p == page %}
      <span class="btn" style="background:transparent;border:1px solid rgba(255,255,255,0.06);
            color:var(--text);padding:6px 10px;border-radius:8px;font-weight:700;">{{ p }}</span>
      {% else %}
      <a class="btn-outline" href="{{ url_for('admin_dashboard', q=q, page=p) }}">{{ p }}</a>
      {% endif %}
      {% endfor %}

      {% if page < total_pages %}
      <a class="btn-outline" href="{{ url_for('admin_dashboard', q=q, page=page+1) }}">Next</a>
      {% endif %}
    </div>
  </div>
</section>
{% endblock %}
